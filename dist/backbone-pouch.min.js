/*! backbone-pouch - v1.1.0 - 2013-07-10
* http://jo.github.io/backbone-pouch/
* Copyright (c) 2013 Johannes J. Schmidt; Licensed MIT */
(function(t){"use strict";function e(t,e){t.options=t.options||{},e.options=e.options||{},t.fetch===void 0&&(t.fetch=e.fetch),t.listen===void 0&&(t.listen=e.listen),t.db===void 0&&(t.db=e.db),i.each(e.options,function(e,n){t.options[n]=t.options[n]||{},i.extend(t.options[n],e)})}var n;n="object"==typeof exports?exports:t.BackbonePouch={};var o=t.$;o||"function"!=typeof require||(o=require("jquery"));var i=t._;i||"function"!=typeof require||(i=require("underscore"));var r={create:"post",update:"put",patch:"put","delete":"remove"};n.defaults={fetch:"allDocs",listen:!0,options:{post:{},put:{},get:{},remove:{},allDocs:{include_docs:!0},query:{include_docs:!0},spatial:{include_docs:!0},changes:{continuous:!0,include_docs:!0}}},n.sync=function(t){t=t||{},e(t,n.defaults);var c=function(n,c,s){function u(t,e){return t?(d.reject(t),s.error&&s.error(t)):(("create"===n||"update"===n||"patch"===n)&&(e={_id:e.id,_rev:e.rev}),"delete"===n&&(e={}),"read"===n&&(e.rows&&(e=i.map(e.rows,function(t){return t.doc||i.extend({_id:t.id},t.value)})),s.listen&&s.db.info(function(t,e){s.db.changes(i.extend({},s.options.changes,{since:e.update_seq,onChange:function(t){var e=c.get(t.id);t.deleted?e&&e.destroy():e?e.set(t.doc):c.add(t.doc),"function"==typeof s.options.changes.onChange&&s.options.changes.onChange(t)}}))})),s.success(e),d.resolve(c,e))}var d=o.Deferred();if(s=s||{},e(s,c&&c.pouch||{}),e(s,t),"string"!=typeof n)return s;if(!s.db)throw Error('A "db" property must be specified');if(c.trigger("request",c,s.db,s),"read"===n){if(c.id)return s.db.get(c.id,s.options.get,u),d.promise();if("query"===s.fetch||"spatial"===s.fetch){if(!s.options[s.fetch].fun)throw Error('A "'+s.fetch+'.fun" object must be specified');return s.db[s.fetch](s.options[s.fetch].fun,s.options[s.fetch],u),d.promise()}s.db[s.fetch](s.options[s.fetch],u)}else s.db[r[n]](c.toJSON(),s.options[r[n]],u);return d.promise()};return c.defaults=t,c},n.attachments=function(t){function e(t,e){return encodeURIComponent(t)+"/"+encodeURIComponent(e)}function n(e){if(e.pouch&&e.pouch.db)return e.pouch.db;if(e.collection&&e.collection.pouch&&e.collection.pouch.db)return e.collection.pouch.db;if(t.db)return t.db;var n=e.sync();if(n.db)return n.db;throw Error('A "db" property must be specified')}return t=t||{},{attachments:function(t){var e=this.get("_attachments")||{};return t?i.filter(i.keys(e),function(n){return"function"==typeof t?t(n,e[n]):e[n].content_type.match(t)}):i.keys(e)},attachment:function(t,o){var i=n(this);return i.getAttachment(e(this.id,t),o)},attach:function(t,o,i,r){"function"==typeof o&&(r=o,o=void 0,i=void 0),"function"==typeof i&&(r=i,i=void 0),o=o||t.filename,i=i||t.type,this.id||this.set({_id:Math.uuid()},{silent:!0});var c=n(this),s=this;return c.putAttachment(e(this.id,o),this.get("_rev"),t,i,function(t,e){if(!t&&e.rev){var n=s.get("_attachments")||{};n[o]={content_type:i,stub:!0},s.set({_rev:e.rev,_attachments:n},{silent:!0})}r(t,e)})}}}})(this);